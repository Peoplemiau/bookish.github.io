<html><head><base href="woah.. i can put anything here :33333">
<title>–ë—É—Ñ–•–æ–ª - –°–æ–≤—Å–µ–º –ù–µ –¢–≤–∏—Ç—Ç–µ—Ä‚Ñ¢Ô∏è</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
<style>
  body {
        font-family: 'Poppins', sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f0f2f5;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }
    #debug-log {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        margin-top: 20px;
        font-family: monospace;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
    }
    .scrolling-banner {
        font-family: 'Poppins', sans-serif;
        background-color: #f0f2f5;
        overflow: hidden;
        white-space: nowrap;
        padding: 10px 0;
        position: relative;
    }
    .scrolling-text {
        display: inline-block;
        min-width: 200%; /* Increase to accommodate duplicated content */
        animation: scroll 120s linear infinite; /* Slower scrolling */
        font-family: 'Poppins', sans-serif; /* Ensure Poppins font is applied */
        will-change: transform;
    }
    .scrolling-banner .scrolling-text:nth-child(2) {
        animation-delay: -120s; /* Matches the animation duration */
    }
    @keyframes scroll {
        from {
            transform: translateX(0);
        }
        to {
            transform: translateX(-50%);
        }
    }
    .container {
        max-width: 600px;
        width: 100%;
        margin: 0 auto;
        padding: 20px;
        box-sizing: border-box;
        flex-grow: 1;
        padding-top: 10px;
    }
    header {
        background-color: #1da1f2;
        color: white;
        padding: 15px 0;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    header h1 {
        margin: 0;
        font-size: 24px;
    }
    header .author {
        font-size: 16px;
        opacity: 0.7;
    }
    .warning-bar {
        background-color: #ffeb3b;
        color: #000000;
        text-align: center;
        padding: 10px 40px 10px 20px;
        font-weight: bold;
        font-size: 14px;
        border-top: 1px solid #ccc;
        position: relative;
    }
    .warning-bar .dismiss-button {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #ffffff;
        font-size: 16px;
        cursor: pointer;
    }
    .post-form {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
    }
    .post-form textarea {
        width: 100%;
        height: 100px;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 10px;
        resize: none;
        font-size: 16px;
        box-sizing: border-box;
        maxlength: 100000;
    }
    .post-form button {
        background-color: #1da1f2;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 16px;
        float: right;
        transition: background-color 0.3s;
    }
    .post-form button:hover {
        background-color: #1991db;
    }
    .post {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
    }
    .post .user-info {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    .post .user-info img {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        margin-right: 10px;
        object-fit: cover;
    }
    .post .user-info .username {
        font-weight: bold;
        font-size: 16px;
    }
    .post .following-indicator {
        font-size: 12px;
        color: #1da1f2;
        opacity: 0.7;
        margin-left: 5px;
    }
    .post .repost-info {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 10px;
        font-size: 14px;
    }
    .post .quote-post {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 10px;
        font-size: 14px;
    }
    .post .quote-user-info {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    .post .quote-user-info img {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        margin-right: 5px;
    }
    .post .quote-content {
        font-style: italic;
    }
    .post .content {
        margin-bottom: 15px;
        font-size: 18px;
        line-height: 1.4;
    }
    .post .actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .post .actions .left-buttons {
        display: flex;
        gap: 15px;
    }
    .post .actions button {
        background-color: transparent;
        border: none;
        color: #657786;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
    }
    .post .actions button:hover {
        color: #1da1f2;
    }
    .post .actions button.liked {
        color: #e0245e;
    }
    .post .actions .report-button {
        padding: 5px;
        background-color: transparent;
        border: none;
        cursor: pointer;
        font-size: 16px;
    }
    .image-upload {
        margin-bottom: 15px;
    }
    .image-upload input {
        display: none;
    }
    .image-upload label {
        background-color: #f0f2f5;
        color: #1da1f2;
        padding: 8px 15px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
    }
    .image-upload label:hover {
        background-color: #e1e8ed;
    }
    .preview-image {
        max-width: 100%;
        max-height: 300px;
        margin-top: 10px;
        border-radius: 8px;
        object-fit: cover;
    }
    .clearfix::after {
        content: "";
        clear: both;
        display: table;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 300px;
        border-radius: 8px;
        text-align: center;
    }
    .modal-content button {
        margin: 10px;
        padding: 10px 20px;
        background-color: #1da1f2;
        color: white;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
    }
    .modal-content button:hover {
        background-color: #1991db;
    }
    #report-modal .modal-content {
        width: 400px;
    }
    #report-reason {
        width: 100%;
        margin: 10px 0;
        padding: 5px;
    }
    .replies {
        margin-top: 10px;
        padding-left: 20px;
        border-left: 2px solid #e1e8ed;
    }
    .reply {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 10px;
    }
    .reply .user-info {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    .reply .user-info img {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        margin-right: 5px;
    }
    .reply .content {
        font-size: 14px;
        margin-bottom: 5px;
    }
    .reply .actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
    }
    .reply-form {
        margin-top: 10px;
        margin-bottom: 10px;
    }
    .reply-form textarea {
        width: 100%;
        height: 60px;
        margin-bottom: 5px;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        resize: none;
        font-size: 14px;
        box-sizing: border-box;
    }
    .reply-form button {
        background-color: #1da1f2;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        float: right;
    }
    .bypass-checkbox {
        margin-bottom: 10px;
        display: none;
    }
</style>
</head>
<body>
<header>
    <h1>–ë—É—Ñ–•–æ–ª<br><span class="author">–û—Ç —Ñ—ã—Ñ–≤–≥–¥—Ñ</span></h1>
</header>
<div class="scrolling-banner">
    <div class="scrolling-text">
         | &nbsp;&nbsp;&nbsp;&nbsp;—á–µ—Ç—ã—Ä–µ –º–∞–ª–µ–Ω—å–∫–∏—Ö –º–∞—Ä–≤–∏–Ω–∞ –ø—Ä—ã–≥–∞—é—Ç –Ω–∞ –∫—Ä–æ–≤–∞—Ç–∏ &nbsp;&nbsp;&nbsp;&nbsp; | &nbsp;&nbsp;&nbsp;&nbsp;–ü–†–ï–ö–†–ê–¢–ò–¢–ï –ö–û–ü–ò–†–û–í–ê–¢–¨ –≠–¢–û–¢ –°–ê–ô–¢&nbsp;&nbsp;&nbsp;&nbsp; | &nbsp;&nbsp;&nbsp;&nbsp;EpicQuest 2025 –∫–æ–≥–¥–∞&nbsp;&nbsp;&nbsp;&nbsp; | &nbsp;&nbsp;&nbsp;&nbsp;–º–∏–∫—É –º–∏–∫—É —É –∏ —É&nbsp;&nbsp;&nbsp;&nbsp; | &nbsp;&nbsp;&nbsp;&nbsp;max design pro - —ç—Ç–æ –ø–∏–∫&nbsp;&nbsp;&nbsp;&nbsp; | &nbsp;&nbsp;&nbsp;&nbsp;
        —á–µ—Ç—ã—Ä–µ –º–∞–ª–µ–Ω—å–∫–∏—Ö –º–∞—Ä–≤–∏–Ω–∞ –ø—Ä—ã–≥–∞—é—Ç –Ω–∞ –∫—Ä–æ–≤–∞—Ç–∏ &nbsp;&nbsp;&nbsp;&nbsp; | &nbsp;&nbsp;&nbsp;&nbsp;–ü–†–ï–ö–†–ê–¢–ò–¢–ï –ö–û–ü–ò–†–û–í–ê–¢–¨ –≠–¢–û–¢ –°–ê–ô–¢&nbsp;&nbsp;&nbsp;&nbsp; | &nbsp;&nbsp;&nbsp;&nbsp;EpicQuest 2025 –∫–æ–≥–¥–∞&nbsp;&nbsp;&nbsp;&nbsp; | &nbsp;&nbsp;&nbsp;&nbsp;–º–∏–∫—É –º–∏–∫—É —É –∏ —É&nbsp;&nbsp;&nbsp;&nbsp; | &nbsp;&nbsp;&nbsp;&nbsp;max design pro - —ç—Ç–æ –ø–∏–∫&nbsp;&nbsp;&nbsp;&nbsp;
    </div>
</div>
<div class="warning-bar">
    –ü–æ—Å—Ç—ã —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏.
    <button class="dismiss-button" onclick="dismissWarningBar()">&times;</button>
</div>
<div class="container">
    <div class="post-form">
        <textarea id="post-content" placeholder="–ß—Ç–æ —É –≤–∞—Å –Ω–æ–≤–æ–≥–æ?" maxlength="100000"></textarea>
        <div class="image-upload">
            <button onclick="openMediaModal()" type="button">–î–æ–±–∞–≤–∏—Ç—å –º–µ–¥–∏–∞</button>
        </div>
        <div class="bypass-checkbox">
            <label>
                <input type="checkbox" id="bypass-moderation">
                –û–±–æ–π—Ç–∏ –º–æ–¥–µ—Ä–∞—Ü–∏—é (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)
            </label>
        </div>
        <img id="preview-image" class="preview-image" style="display: none;">
        <div class="clearfix">
            <button onclick="createPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        </div>
    </div>
    <div id="posts-container"></div>
    <div id="debug-log"></div>
</div>
<div id="media-modal" class="modal">
    <div class="modal-content">
        <h2>–î–æ–±–∞–≤–∏—Ç—å –º–µ–¥–∏–∞</h2>
        <button onclick="selectMediaType('image')">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
        <button onclick="openVideoUrlPopup()">–î–æ–±–∞–≤–∏—Ç—å URL –≤–∏–¥–µ–æ/GIF</button>
        <input type="file" id="image-input" accept="image/*" style="display: none;">
        <button onclick="closeMediaModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>
<div id="video-url-popup" class="modal">
    <div class="modal-content">
        <h2>–í–≤–µ–¥–∏—Ç–µ URL –≤–∏–¥–µ–æ/GIF</h2>
        <input type="text" id="video-url-input" placeholder="–í–≤–µ–¥–∏—Ç–µ URL –≤–∏–¥–µ–æ/GIF">
        <button onclick="addVideoUrl()">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button onclick="closeVideoUrlPopup()">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>
<div id="report-modal" class="modal">
    <div class="modal-content">
        <h2>–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ –ø–æ—Å—Ç</h2>
        <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ —ç—Ç–æ—Ç –ø–æ—Å—Ç –∑–∞ –Ω–µ–ø—Ä–∏–µ–º–ª–µ–º–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ?</p>
        <select id="report-reason">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</option>
            <option value="personal_info">–†–∞—Å–∫—Ä—ã–≤–∞–µ—Ç –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é –ª–∏—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</option>
            <option value="nsfw_image">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö</option>
            <option value="spam">–°–ø–∞–º</option>
            <option value="harassment">–ü—Ä–µ—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ</option>
        </select>
        <button onclick="confirmReport()">–î–∞, –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è</button>
        <button onclick="closeReportModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>
<div id="posting-modal" class="modal">
    <div class="modal-content">
        <h2>–ü—É–±–ª–∏–∫–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞...</h2>
        <div class="spinner"></div>
    </div>
</div>
<div id="blocked-post-modal" class="modal">
    <div class="modal-content">
        <h2>–ò–∑–≤–∏–Ω–∏—Ç–µ, —ç—Ç–æ—Ç –ø–æ—Å—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!</h2>
        <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ —Å –¥—Ä—É–≥–∏–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ–º.</p>
        <button onclick="closeBlockedPostModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>
<div id="repost-modal" class="modal">
    <div class="modal-content">
        <h2>–†–µ–ø–æ—Å—Ç</h2>
        <p>–ö–∞–∫ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å —Ä–µ–ø–æ—Å—Ç?</p>
        <button onclick="repostPost()">–†–µ–ø–æ—Å—Ç</button>
        <button onclick="quoteRepostPost()">–¶–∏—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ—Å—Ç</button>
        <button onclick="closeRepostModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>
<script>
const adminUsers = ['kasaneteto', 'Sophie_', 'enchantedmist43039873', '—Ñ—ã—Ñ–≤–≥–¥—Ñ'];

// Update all error messages and alerts to Russian
function createPost() {
    log('–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞...');
    const content = document.getElementById('post-content').value;
    const imageInput = document.getElementById('image-input');
    const videoUrlInput = document.getElementById('video-url-input');
    const imageFile = imageInput.files[0];
    const videoUrl = videoUrlInput.value.trim();
    const currentUsername = getCurrentUsername();
    const isAdmin = adminUsers.includes(currentUsername);

    const bypassModerationElement = document.getElementById('bypass-moderation');
    const bypassModeration = isAdmin && bypassModerationElement ? bypassModerationElement.checked : false;

    if (content.trim() === '' && !imageFile && !videoUrl) {
        log('–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ –ø—É—Å—Ç–æ –∏ –º–µ–¥–∏–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ');
        alert('–í–∞—à –ø–æ—Å—Ç –ø—É—Å—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –º–µ–¥–∏–∞-–∫–æ–Ω—Ç–µ–Ω—Ç.');
        return;
    }

    if (!isAdmin && content.length > 450) {
        log('–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 450 —Å–∏–º–≤–æ–ª–æ–≤');
        alert('–í–∞—à –ø–æ—Å—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–∫—Ä–∞—Ç–∏—Ç–µ –µ–≥–æ –¥–æ 450 —Å–∏–º–≤–æ–ª–æ–≤.');
        return;
    }

    showPostingModal();

    let shouldBlock = false;
    if (!bypassModeration) {
        shouldBlock = await checkPostContent(content);
    }

    if (shouldBlock) {
        hidePostingModal();
        showBlockedPostModal();
        log('–ü–æ—Å—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –º–æ–¥–µ—Ä–∞—Ü–∏–µ–π –∫–æ–Ω—Ç–µ–Ω—Ç–∞');
        return;
    }

    const post = {
        id: Date.now(),
        content: content,
        username: currentUsername,
        avatarUrl: room.party.client?.avatarUrl || 'default-avatar.png',
        likes: 0,
        likedBy: [],
        reposts: 0,
        replies: [],
        timestamp: new Date().toISOString()
    };

    if (imageFile) {
        log('–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, —á–∏—Ç–∞–µ–º...');
        try {
            const imageUrl = await readFileAsDataURL(imageFile);
            post.mediaUrl = await compressImage(imageUrl);
            post.mediaType = 'image';
        } catch (error) {
            log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${error}`);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            hidePostingModal();
            return;
        }
    } else if (videoUrl) {
        if (isValidMediaUrl(videoUrl)) {
            post.mediaUrl = videoUrl;
            post.mediaType = 'video';
        } else {
            alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL –≤–∏–¥–µ–æ/GIF. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–∞–π–ª .mp4, .webm –∏–ª–∏ .gif.');
            hidePostingModal();
            return;
        }
    }

    log(`–û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ—Å—Ç–∞: ${JSON.stringify(post)}`);
    await sendPost(post);

    document.getElementById('post-content').value = '';
    imageInput.value = '';
    videoUrlInput.value = '';
    document.getElementById('preview-image').style.display = 'none';
    log('–ü–æ—Å—Ç —Å–æ–∑–¥–∞–Ω –∏ —Ñ–æ—Ä–º–∞ –æ—á–∏—â–µ–Ω–∞');
    hidePostingModal();
}

async function compressImage(imageUrl) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            let width = img.width;
            let height = img.height;
            const maxDimension = 800;

            if (width > height && width > maxDimension) {
                height *= maxDimension / width;
                width = maxDimension;
            } else if (height > maxDimension) {
                width *= maxDimension / height;
                height = maxDimension;
            }

            canvas.width = width;
            canvas.height = height;

            ctx.drawImage(img, 0, 0, width, height);

            const compressedImageUrl = canvas.toDataURL('image/jpeg', 0.7);
            resolve(compressedImageUrl);
        };
        img.onerror = reject;
        img.src = imageUrl;
    });
}

async function checkPostContent(content, reason = '') {
    const prompt = `–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ—Ç –ø–æ—Å—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏–º –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≤ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç–µ. –í—ã –¥–æ–ª–∂–Ω—ã –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞—Ç—å—Å—è –¥–æ–≤–æ–ª—å–Ω–æ –ª–µ–≥–∫–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π, –Ω–æ —Ü–µ–ª–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –ø—Ä–µ—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ, –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è –∏ –≤–æ–æ–±—â–µ –ø–ª–æ—Ö–∏–µ –≤–µ—â–∏ –Ω–µ –¥–æ–ø—É—Å–∫–∞—é—Ç—Å—è. –ü–æ—Å—Ç –±—ã–ª —Å–æ–æ–±—â–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º${reason ? ` –ø–æ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–∏—á–∏–Ω–µ: ${reason}` : ''}. –í–µ—Ä–Ω–∏—Ç–µ JSON –∑–Ω–∞—á–µ–Ω–∏–µ boolean —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º "block" –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–æ–≥–æ, —Å–ª–µ–¥—É–µ—Ç –ª–∏ —É–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç –∏–ª–∏ –Ω–µ—Ç.

–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ—Å—Ç–∞: "${content}"

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
{
  "block": boolean
}`;

    try {
        const response = await fetch('/api/ai_completion', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
            },
            body: JSON.stringify({
                prompt: prompt,
                data: content
            }),
        });
        const data = await response.json();
        return data.block;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è –ø–æ—Å—Ç–∞:', error);
        return false; // –ù–µ —É–¥–∞–ª—è—Ç—å –ø–æ—Å—Ç –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
    }
}

function showPostingModal() {
    document.getElementById('posting-modal').style.display = 'block';
}

function hidePostingModal() {
    document.getElementById('posting-modal').style.display = 'none';
}

function showBlockedPostModal() {
    document.getElementById('blocked-post-modal').style.display = 'block';
}

function closeBlockedPostModal() {
    document.getElementById('blocked-post-modal').style.display = 'none';
}

async function sendPost(post) {
    try {
        log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ —Å –Ω–æ–≤—ã–º –ø–æ—Å—Ç–æ–º');
        await room.store.update({
            id: 'posts',
            dependencies: { post },
            updateFunction: (posts) => {
                if (!posts) posts = [];
                return [post, ...posts].slice(0, 50);
            }
        });

        log('–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞');
        await room.send({
            type: 'newPost',
            post: post
        });

        log('–ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
        await fetchAndRenderPosts();
    } catch (error) {
        log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø–æ—Å—Ç–∞: ${error}`);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤–∞—à–µ–≥–æ –ø–æ—Å—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
    }
}

function addPost(post) {
    log(`–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞ –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤: ${JSON.stringify(post)}`);
    posts.unshift(post);
    posts = posts.slice(0, 50);
    renderPosts();
}

function renderPosts() {
    log(`–û—Ç—Ä–∏—Å–æ–≤–∫–∞ ${posts.length} –ø–æ—Å—Ç–æ–≤`);
    const container = document.getElementById('posts-container');
    container.innerHTML = '';
    posts.forEach(post => {
        const postElement = document.createElement('div');
        postElement.className = 'post';
        postElement.innerHTML = renderPost(post);
        container.appendChild(postElement);
    });
}

function renderPost(post) {
    const isLiked = post.likedBy.includes(getCurrentUsername());
    const isFollowing = post.isFollowing;
    return `
        <div class="user-info">
            <img src="${post.avatarUrl}" alt="${post.username}">
            <span class="username">${post.username}</span>
            ${isFollowing ? '<span class="following-indicator">–ü–æ–¥–ø–∏—Å–∫–∞</span>' : ''}
        </div>
        ${post.repostOf ? `<div class="repost-info">–†–µ–ø–æ—Å—Ç –æ—Ç ${post.repostOf.username}</div>` : ''}
        ${post.quoteOf ? `
            <div class="quote-post">
                <div class="quote-user-info">
                    <img src="${post.quoteOf.avatarUrl}" alt="${post.quoteOf.username}">
                    <span class="username">${post.quoteOf.username}</span>
                </div>
                <div class="quote-content">${post.quoteOf.content}</div>
            </div>
        ` : ''}
        <div class="content">${post.content}</div>
        ${post.mediaUrl ? renderMedia(post) : ''}
        <div class="actions">
            <div class="left-buttons">
                <button onclick="likePost(${post.id})" class="${isLiked ? 'liked' : ''}">
                    ${isLiked ? '‚ù§Ô∏è' : 'ü§ç'} ${post.likes}
                </button>
                <button onclick="openRepostModal(${post.id})">üîÅ ${post.reposts}</button>
                <button onclick="toggleReplyForm(${post.id})">üí¨ ${post.replies ? post.replies.length : 0}</button>
            </div>
            <span>${new Date(post.timestamp).toLocaleString('ru-RU')}</span>
            <button onclick="reportPost(${post.id})" class="report-button">‚ö†Ô∏è</button>
        </div>
        <div id="reply-form-${post.id}" class="reply-form" style="display: none;">
            <textarea id="reply-content-${post.id}" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –æ—Ç–≤–µ—Ç..."></textarea>
            <div class="clearfix">
                <button onclick="submitReply(${post.id})">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
            </div>
        </div>
        <div id="replies-${post.id}" class="replies">
            ${post.replies ? post.replies.map(reply => `
                <div class="reply">
                    <div class="user-info">
                        <img src="${reply.avatarUrl}" alt="${reply.username}">
                        <span class="username">${reply.username}</span>
                    </div>
                    <div class="content">${reply.content}</div>
                    <div class="actions">
                        <button onclick="likePost(${reply.id})" class="${reply.likedBy.includes(getCurrentUsername()) ? 'liked' : ''}">
                            ${reply.likedBy.includes(getCurrentUsername()) ? '‚ù§Ô∏è' : 'ü§ç'} ${reply.likes}
                        </button>
                        <span>${new Date(reply.timestamp).toLocaleString('ru-RU')}</span>
                    </div>
                </div>
            `).join('') : ''}
        </div>
    `;
}

function toggleReplyForm(postId) {
    const replyForm = document.getElementById(`reply-form-${postId}`);
    replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
}

async function submitReply(postId) {
    const content = document.getElementById(`reply-content-${postId}`).value;
    if (content.trim() === '') return;

    const reply = {
        id: Date.now(),
        content: content,
        username: getCurrentUsername(),
        avatarUrl: room.party.client?.avatarUrl || 'default-avatar.png',
        likes: 0,
        likedBy: [],
        reposts: 0,
        timestamp: new Date().toISOString()
    };

    try {
        await room.store.update({
            id: 'posts',
            dependencies: { reply, postId },
            updateFunction: (posts) => {
                return posts.map(post => {
                    if (post.id === postId) {
                        return {
                            ...post,
                            replies: [...(post.replies || []), reply]
                        };
                    }
                    return post;
                });
            }
        });

        document.getElementById(`reply-content-${postId}`).value = '';
        await fetchAndRenderPosts();
    } catch (error) {
        log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–∞: ${error}`);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤–∞—à–µ–≥–æ –æ—Ç–≤–µ—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
    }
}

function openRepostModal(postId) {
    currentRepostId = postId;
    document.getElementById('repost-modal').style.display = 'block';
}

async function repostPost() {
    if (currentRepostId === null) return;
    const originalPost = posts.find(p => p.id === currentRepostId);
    if (!originalPost) return;

    const repost = {
        id: Date.now(),
        content: originalPost.content,
        username: getCurrentUsername(),
        avatarUrl: room.party.client?.avatarUrl || 'default-avatar.png',
        likes: 0,
        likedBy: [],
        reposts: 0,
        repostOf: {
            username: originalPost.username,
            id: originalPost.id
        },
        timestamp: new Date().toISOString()
    };

    try {
        await room.store.update({
            id: 'posts',
            dependencies: { repost },
            updateFunction: (posts) => {
                return [repost, ...posts].slice(0, 50);
            }
        });

        await room.store.update({
            id: 'posts',
            dependencies: { currentRepostId },
            updateFunction: (posts) => {
                return posts.map(post => {
                    if (post.id === currentRepostId) {
                        return { ...post, reposts: post.reposts + 1 };
                    }
                    return post;
                });
            }
        });

        closeRepostModal();
        await fetchAndRenderPosts();
    } catch (error) {
        log(`–û—à–∏–±–∫–∞ —Ä–µ–ø–æ—Å—Ç–∞: ${error}`);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–ø–æ—Å—Ç–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
    }
}

async function quoteRepostPost() {
    if (currentRepostId === null) return;
    const originalPost = posts.find(p => p.id === currentRepostId);
    if (!originalPost) return;

    const content = prompt("–î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ä–µ–ø–æ—Å—Ç—É:");
    if (content === null) return;

    const quoteRepost = {
        id: Date.now(),
        content: content,
        username: getCurrentUsername(),
        avatarUrl: room.party.client?.avatarUrl || 'default-avatar.png',
        likes: 0,
        likedBy: [],
        reposts: 0,
        quoteOf: {
            username: originalPost.username,
            content: originalPost.content,
            avatarUrl: originalPost.avatarUrl,
            id: originalPost.id
        },
        timestamp: new Date().toISOString()
    };

    try {
        await room.store.update({
            id: 'posts',
            dependencies: { quoteRepost },
            updateFunction: (posts) => {
                return [quoteRepost, ...posts].slice(0, 50);
            }
        });

        await room.store.update({
            id: 'posts',
            dependencies: { currentRepostId },
            updateFunction: (posts) => {
                return posts.map(post => {
                    if (post.id === currentRepostId) {
                        return { ...post, reposts: post.reposts + 1 };
                    }
                    return post;
                });
            }
        });

        closeRepostModal();
        await fetchAndRenderPosts();
    } catch (error) {
        log(`–û—à–∏–±–∫–∞ —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–ø–æ—Å—Ç–∞: ${error}`);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ä–µ–ø–æ—Å—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
    }
}

function closeRepostModal() {
    currentRepostId = null;
    document.getElementById('repost-modal').style.display = 'none';
}

document.getElementById('image-input').addEventListener('change', function(event) {
    updateMediaPreview();
});

function isValidMediaUrl(url) {
    const allowedExtensions = ['.mp4', '.webm', '.gif'];
    const urlLower = url.toLowerCase();
    return allowedExtensions.some(ext => urlLower.endsWith(ext)) && !urlLower.includes('discord.com');
}

function renderMedia(post) {
    if (post.mediaType === 'image') {
        return `<img src="${post.mediaUrl}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å—Ç–∞" style="max-width: 100%; border-radius: 8px; margin-bottom: 15px;">`;
    } else if (post.mediaType === 'video') {
        if (post.mediaUrl.toLowerCase().endsWith('.gif')) {
            return `<img src="${post.mediaUrl}" alt="GIF –ø–æ—Å—Ç–∞" style="max-width: 100%; border-radius: 8px; margin-bottom: 15px;">`;
        } else {
            return `
                <video controls style="max-width: 100%; border-radius: 8px; margin-bottom: 15px;">
                    <source src="${post.mediaUrl}" type="video/${post.mediaUrl.split('.').pop()}">
                    –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–µ–≥ –≤–∏–¥–µ–æ.
                </video>
            `;
        }
    }
    return '';
}

log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤ –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞');
fetchAndRenderPosts();

window.addEventListener('resize', renderPosts);

log('–ë—É—Ñ–•–æ–ª –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');

function reportPost(postId) {
    currentReportId = postId;
    document.getElementById('report-modal').style.display = 'block';
}

function closeReportModal() {
    currentReportId = null;
    document.getElementById('report-modal').style.display = 'none';
}

async function confirmReport() {
    if (currentReportId === null) return;
    const post = posts.find(p => p.id === currentReportId);
    if (!post) return;

    const reason = document.getElementById('report-reason').value;

    showPostingModal();

    const shouldDelete = await checkPostContent(post.content, reason);

    hidePostingModal();

    if (shouldDelete) {
        await deletePost(currentReportId);
        alert('–°–æ–æ–±—â–µ–Ω–Ω—ã–π –ø–æ—Å—Ç –æ–∫–∞–∑–∞–ª—Å—è –Ω–µ–ø—Ä–∏–µ–º–ª–µ–º—ã–º –∏ –±—ã–ª —É–¥–∞–ª–µ–Ω.');
    } else {
        alert('–°–æ–æ–±—â–µ–Ω–Ω—ã–π –ø–æ—Å—Ç –Ω–µ –±—ã–ª –ø—Ä–∏–∑–Ω–∞–Ω –Ω–µ–ø—Ä–∏–µ–º–ª–µ–º—ã–º.');
    }

    closeReportModal();
    await fetchAndRenderPosts();
}

async function deletePost(postId) {
    try {
        await room.store.update({
            id: 'posts',
            dependencies: { postId },
            updateFunction: (posts) => {
                return posts.filter(post => post.id !== postId);
            }
        });
    } catch (error) {
        log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ—Å—Ç–∞: ${error}`);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ—Å—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
    }
}

async function likePost(id) {
    const currentUsername = getCurrentUsername();

    try {
        await room.store.update({
            id: 'posts',
            dependencies: { id, currentUsername },
            updateFunction: (posts) => {
                return posts.map(post => {
                    if (post.id === id) {
                        const isLiked = post.likedBy.includes(currentUsername);
                        return {
                            ...post,
                            likes: isLiked ? post.likes - 1 : post.likes + 1,
                            likedBy: isLiked
                                ? post.likedBy.filter(username => username !== currentUsername)
                                : [...post.likedBy, currentUsername]
                        };
                    } else if (post.replies) {
                        return {
                            ...post,
                            replies: post.replies.map(reply => {
                                if (reply.id === id) {
                                    const isLiked = reply.likedBy.includes(currentUsername);
                                    return {
                                        ...reply,
                                        likes: isLiked ? reply.likes - 1 : reply.likes + 1,
                                        likedBy: isLiked
                                            ? reply.likedBy.filter(username => username !== currentUsername)
                                            : [...reply.likedBy, currentUsername]
                                    };
                                }
                                return reply;
                            })
                        };
                    }
                    return post;
                });
            }
        });

        await fetchAndRenderPosts();
    } catch (error) {
        log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ª–∞–π–∫–µ –ø–æ—Å—Ç–∞: ${error}`);
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ª–∞–π–∫–µ –ø–æ—Å—Ç–∞:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ª–∞–π–∫–µ –ø–æ—Å—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
    }
}

function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (event) => resolve(event.target.result);
        reader.onerror = (error) => reject(error);
        reader.readAsDataURL(file);
    });
}

function updatePostForm() {
    const postForm = document.querySelector('.post-form');
    const currentUsername = getCurrentUsername();
    const isAdmin = adminUsers.includes(currentUsername);

    const bypassCheckboxContainer = document.querySelector('.bypass-checkbox');
    if (isAdmin) {
        bypassCheckboxContainer.style.display = 'block';
    } else {
        bypassCheckboxContainer.style.display = 'none';
    }

    const textArea = document.getElementById('post-content');
    textArea.maxLength = isAdmin ? 100000 : 450;
}

room.onPeersChanged = () => {
    updatePostForm();
};

updatePostForm();

function dismissWarningBar() {
    const warningBar = document.querySelector('.warning-bar');
    if (warningBar) {
        warningBar.style.display = 'none';
    }
}
</script>
</body></html>
