<!DOCTYPE html>
<html lang="en">
<head>
  <base href="https://every-ai-chat-free.com/">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ORKGPT</title>

  <!-- Include highlight.js styles -->
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
  
  <style>
    /* Ваши стили остаются без изменений */
    body, html {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #1a1a1a;
      color: #e0e0e0;
      height: 100%;
      overflow: hidden;
    }

    .container {
      display: flex;
      height: 100vh;
      width: 100vw;
    }

    .sidebar {
      width: 220px;
      min-width: 220px;
      background-color: #2c2c2c;
      color: #e0e0e0;
      padding: 15px;
      overflow-y: auto;
      box-shadow: 2px 0 5px rgba(0,0,0,0.5);
    }

    .main-content {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      overflow-y: auto;
      background-color: #1a1a1a;
    }

    .header {
      text-align: center;
      margin-bottom: 15px;
      color: #e0e0e0;
      position: relative;
    }

    .header h1 {
      margin: 0;
      font-size: 24px;
      font-weight: normal;
    }

    .chat-area {
      flex-grow: 1;
      background-color: #2a2a2a;
      border-radius: 4px;
      padding: 10px;
      overflow-y: auto;
      margin-bottom: 15px;
      color: #e0e0e0;
    }

    .footer {
      text-align: center;
      font-size: 12px;
      color: #a0a0a0;
      margin-top: 10px;
    }

    #userInput {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      background-color: #333333;
      color: #e0e0e0;
      border: 1px solid #444444;
      border-radius: 4px;
      resize: vertical;
      min-height: 40px;
      max-height: 150px;
      font-size: 14px;
    }

    #sendButton, #uploadButton {
      width: 100%;
      padding: 10px;
      background-color: #006bb3;
      color: #ffffff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 10px;
      font-size: 14px;
    }

    #sendButton:hover, #uploadButton:hover {
      background-color: #005a99;
    }

    #modelSelect {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      background-color: #333333;
      color: #e0e0e0;
      border: 1px solid #444444;
      border-radius: 4px;
      font-size: 14px;
    }

    .created-by {
      position: absolute;
      bottom: 10px;
      right: 15px;
      font-size: 12px;
      color: #a0a0a0;
    }

    .message {
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 4px;
      word-wrap: break-word;
      white-space: pre-wrap;
      background-color: #1a1a1a;
      border-left: 4px solid #006bb3;
    }

    .user {
      background-color: #333333;
      border-left-color: #006bb3;
    }

    .assistant {
      background-color: #2a2a2a;
      border-left-color: #ff9900;
    }

    .system {
      background-color: #2a2a2a;
      font-style: italic;
      border-left-color: #999999;
    }

    .message code {
      background-color: #1a1a1a;
      padding: 2px 4px;
      border-radius: 3px;
      font-family: 'Courier New', Courier, monospace;
      color: #ff9900;
    }

    .message pre code {
      display: block;
      padding: 10px;
      background-color: #1a1a1a;
      overflow-x: auto;
      color: #ff9900;
    }

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top: 2px solid #006bb3;
      animation: spin 1s linear infinite;
      vertical-align: middle;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .chat-history-item {
      cursor: pointer;
      padding: 8px;
      margin-bottom: 5px;
      background-color: #3a3a3a;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.3s ease;
      font-size: 14px;
    }

    .chat-history-item:hover {
      background-color: #4a4a4a;
    }

    .chat-history-item.selected {
      background-color: #4a4a4a;
    }

    .chat-history-buttons {
      display: flex;
      gap: 5px;
    }

    .chat-history-button {
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 3px;
      padding: 2px 5px;
      font-size: 10px;
      cursor: pointer;
    }

    .chat-history-button:hover {
      background-color: #777777;
    }

    .new-chat-button {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      background-color: #006bb3;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    .new-chat-button:hover {
      background-color: #005a99;
    }

    #debugButton {
      position: absolute;
      top: 10px;
      right: 15px;
      background-color: #555555;
      color: white;
      border: none;
      border-radius: 3px;
      padding: 5px 10px;
      font-size: 12px;
      cursor: pointer;
    }

    #debugButton:hover {
      background-color: #777777;
    }

    .eyeball-button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      padding: 0 3px;
      color: #e0e0e0;
    }

    .popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #2a2a2a;
      padding: 20px;
      border-radius: 4px;
      z-index: 1000;
      max-width: 80%;
      max-height: 80%;
      overflow-y: auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.7);
    }

    .popup-content {
      color: #e0e0e0;
      white-space: pre-wrap;
      font-size: 14px;
    }

    .close-popup {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }

    .overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      z-index: 999;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <button class="new-chat-button" id="newChatButton">New Chat</button>
      <div id="chatHistory"></div>
    </div>
    <div class="main-content">
      <div class="header">
        <h1>ORKGPT</h1>
        <button id="debugButton">Debug</button>
      </div>
      <div class="chat-area" id="chat-area">
        <!-- Chat messages will be inserted here -->
      </div>
      <textarea id="userInput" placeholder="Type your message here..."></textarea>
      <button id="sendButton">Send</button>
      <!-- File upload button -->
      <input type="file" id="fileInput" style="display: none;" multiple />
      <button id="uploadButton">Upload Files</button>
      <select id="modelSelect">
        <option value="">Loading models...</option>
      </select>
      <div class="footer">
        ORKGPT. Free Research Preview. Our goal is to make AI systems more natural and safe to interact with. Your feedback will help us improve.
      </div>
      <div class="created-by">Created by @laznin ⚡</div>
    </div>
  </div>

  <div id="overlay" class="overlay"></div>
  <div id="popup" class="popup">
    <button class="close-popup" onclick="closePopup()">×</button>
    <div id="popupContent" class="popup-content"></div>
  </div>

  <!-- Include highlight.js script -->
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <script>
    // Initialize highlight.js
    hljs.highlightAll();
  </script>

  <script>
    const systemPrompt = `You are ORKGPT, an AI assistant. Respond in a clear, professional, and concise manner. Provide code snippets when necessary with proper syntax highlighting. Use fractions instead of decimal numbers where applicable. Do not alter code blocks.`;
    let selectedModel = '';
    let currentChatId = null;
    let debugMode = false;

    function generateUniqueId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function addMessage(role, content) {
      const chatArea = document.getElementById('chat-area');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${role}`;

      const prefix = role === 'user' ? 'User: ' : (role === 'assistant' ? 'ORKGPT: ' : 'System: ');

      const messageContent = document.createElement('div');
      
      if (role === 'assistant') {
        // Преобразуем десятичные числа в дроби для сообщений ассистента
        content = convertDecimalsToFractions(content);
      }

      messageContent.innerHTML = prefix + content;

      messageContent.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightElement(block);
      });

      messageDiv.appendChild(messageContent);
      chatArea.appendChild(messageDiv);
      chatArea.scrollTop = chatArea.scrollHeight;

      if (currentChatId) {
        let chats = JSON.parse(localStorage.getItem('aiChats')) || {};
        if (!chats[currentChatId]) {
          chats[currentChatId] = { messages: [], name: `Chat ${currentChatId.substr(0, 6)}...` };
        }
        const messageExists = chats[currentChatId].messages.some(
          m => m.role === role && m.content === content
        );
        if (!messageExists) {
          chats[currentChatId].messages.push({role, content});
          localStorage.setItem('aiChats', JSON.stringify(chats));
        }
        updateChatHistory();
      }
    }

    function addLoadingSpinner() {
      const chatArea = document.getElementById('chat-area');
      const spinnerDiv = document.createElement('div');
      spinnerDiv.className = 'message system';
      spinnerDiv.innerHTML = 'ORKGPT: <div class="loading-spinner"></div>';
      chatArea.appendChild(spinnerDiv);
      chatArea.scrollTop = chatArea.scrollHeight;
      return spinnerDiv;
    }

    function startNewChat() {
      currentChatId = generateUniqueId();
      document.getElementById('chat-area').innerHTML = '';
      addMessage('system', 'Hello! How can I assist you today?');
      updateChatHistory();
    }

    function updateChatHistory() {
      const chatHistory = document.getElementById('chatHistory');
      chatHistory.innerHTML = '';
      const chats = JSON.parse(localStorage.getItem('aiChats')) || {};
      Object.keys(chats).forEach(chatId => {
        const chatDiv = document.createElement('div');
        chatDiv.className = 'chat-history-item';
        if (chatId === currentChatId) {
          chatDiv.classList.add('selected');
        }
        
        const chatName = document.createElement('span');
        chatName.textContent = chats[chatId].name || `Chat ${chatId.substr(0, 6)}...`;
        chatDiv.appendChild(chatName);
        
        const buttonsDiv = document.createElement('div');
        buttonsDiv.className = 'chat-history-buttons';
        
        const renameButton = document.createElement('button');
        renameButton.textContent = 'Rename';
        renameButton.className = 'chat-history-button';
        renameButton.onclick = (e) => {
          e.stopPropagation();
          renameChat(chatId);
        };
        
        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'Delete';
        deleteButton.className = 'chat-history-button';
        deleteButton.onclick = (e) => {
          e.stopPropagation();
          deleteChat(chatId);
        };
        
        if (debugMode) {
          const eyeballButton = document.createElement('button');
          eyeballButton.innerHTML = '👁️';
          eyeballButton.className = 'eyeball-button';
          eyeballButton.onclick = (e) => {
            e.stopPropagation();
            showChatData(chatId);
          };
          buttonsDiv.appendChild(eyeballButton);
        }
        
        buttonsDiv.appendChild(renameButton);
        buttonsDiv.appendChild(deleteButton);
        
        chatDiv.appendChild(buttonsDiv);
        chatHistory.appendChild(chatDiv);
        
        chatDiv.onclick = () => loadChat(chatId);
      });
    }

    function loadChat(chatId) {
      if (currentChatId === chatId) return;
      currentChatId = chatId;
      const chats = JSON.parse(localStorage.getItem('aiChats')) || {};
      const chatMessages = chats[chatId].messages || [];
      const chatArea = document.getElementById('chat-area');
      chatArea.innerHTML = '';
      chatMessages.forEach(message => addMessage(message.role, message.content));
      updateChatHistory();
    }

    function renameChat(chatId) {
      const chats = JSON.parse(localStorage.getItem('aiChats')) || {};
      const newName = prompt('Enter new name for the chat:', chats[chatId].name);
      if (newName !== null) {
        chats[chatId].name = newName;
        localStorage.setItem('aiChats', JSON.stringify(chats));
        updateChatHistory();
      }
    }

    function deleteChat(chatId) {
      if (confirm('Are you sure you want to delete this chat?')) {
        const chats = JSON.parse(localStorage.getItem('aiChats')) || {};
        delete chats[chatId];
        localStorage.setItem('aiChats', JSON.stringify(chats));
        if (currentChatId === chatId) {
          startNewChat();
        } else {
          updateChatHistory();
        }
      }
    }

    function showChatData(chatId) {
      const chats = JSON.parse(localStorage.getItem('aiChats')) || {};
      const chatData = chats[chatId];
      const totalCharCount = chatData.messages.reduce((count, message) => count + message.content.length, 0);
      
      let popupContent = `Chat ID: ${chatId}\n`;
      popupContent += `Chat Name: ${chatData.name}\n`;
      popupContent += `Total Character Count: ${totalCharCount}\n\n`;
      popupContent += `Messages:\n`;
      chatData.messages.forEach((message, index) => {
        popupContent += `\n[${index + 1}] ${message.role}: ${message.content}\n`;
      });
    
      document.getElementById('popupContent').textContent = popupContent;
      document.getElementById('popup').style.display = 'block';
      document.getElementById('overlay').style.display = 'block';
    }

    function closePopup() {
      document.getElementById('popup').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    }

    fetch('https://api.llmplayground.net/v1/models')
      .then(response => response.json())
      .then(data => {
        const select = document.getElementById('modelSelect');
        select.innerHTML = '';
        data.data.forEach(model => {
          const option = document.createElement('option');
          option.value = model.id;
          option.textContent = model.id;
          select.appendChild(option);
        });
        select.value = 'gpt-4';
        selectedModel = 'gpt-4';
      })
      .catch(error => console.error('Error fetching AI models:', error));

    document.getElementById('modelSelect').addEventListener('change', (event) => {
      selectedModel = event.target.value;
    });

    function sendMessage() {
      const userInput = document.getElementById('userInput');
      const message = userInput.value.trim();
      if (message) {
        addMessage('user', message);
        sendMessageToAI(message);
        userInput.value = '';
      }
    }

    document.getElementById('sendButton').addEventListener('click', sendMessage);
    document.getElementById('userInput').addEventListener('keydown', (event) => {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    });

    function sendMessageToAI(message) {
      const loadingSpinner = addLoadingSpinner();
      fetch('https://api.llmplayground.net/v1/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: selectedModel,
          messages: [
            { role: 'system', content: systemPrompt },
            ...getCurrentChatMessages(),
            { role: 'user', content: message }
          ],
          max_tokens: 2048,
          temperature: 0.7,
        })
      })
      .then(response => response.json())
      .then(data => {
        loadingSpinner.remove();
        if (data.choices && data.choices.length > 0) {
          addMessage('assistant', data.choices[0].message.content);
        } else {
          addMessage('system', 'Sorry, I couldn\'t generate a response.');
        }
      })
      .catch(error => {
        loadingSpinner.remove();
        console.error('Error sending message to AI:', error);
        addMessage('system', 'Sorry, there was an error communicating with the AI.');
      });
    }

    function getCurrentChatMessages() {
      const chats = JSON.parse(localStorage.getItem('aiChats')) || {};
      return currentChatId && chats[currentChatId] ? chats[currentChatId].messages : [];
    }

    document.getElementById('newChatButton').addEventListener('click', startNewChat);

    document.getElementById('debugButton').addEventListener('click', () => {
      debugMode = !debugMode;
      updateChatHistory();
    });

    updateChatHistory();
    if (!currentChatId) {
      startNewChat();
    } else {
      loadChat(currentChatId);
    }

    document.getElementById('overlay').addEventListener('click', closePopup);

    document.getElementById('uploadButton').addEventListener('click', () => {
      document.getElementById('fileInput').click();
    });

    document.getElementById('fileInput').addEventListener('change', handleFileUpload);

    function handleFileUpload(event) {
      const files = event.target.files;
      if (files.length > 0) {
        Array.from(files).forEach(file => {
          const reader = new FileReader();
          reader.onload = function(e) {
            const content = e.target.result;
            addMessage('user', `Uploaded file: ${file.name}\n\nContent:\n${content}`);
          };
          reader.readAsText(file);
        });
      }
    }

    /**
     * Функция для преобразования десятичных чисел в дроби
     * @param {string} text - Текст сообщения
     * @returns {string} - Обновленный текст с дробями
     */
    function convertDecimalsToFractions(text) {
      // Разделяем текст на части, исключая кодовые блоки
      const parts = text.split(/(```[\s\S]*?```)/g);
      for (let i = 0; i < parts.length; i++) {
        // Пропускаем кодовые блоки
        if (parts[i].startsWith('```')) continue;
        // Регулярное выражение для поиска десятичных чисел (включая отрицательные)
        const decimalRegex = /(-?\d+\.\d+)/g;
        parts[i] = parts[i].replace(decimalRegex, (match) => {
          const decimal = parseFloat(match);
          // Если число целое (например, 25.0), возвращаем целое число
          if (Number.isInteger(decimal)) {
            return decimal.toString();
          }
          const fraction = decimalToFraction(decimal);
          return fraction ? fraction : match;
        });
      }
      return parts.join('');
    }

    /**
     * Преобразование десятичного числа в дробь
     * @param {number} decimal - Десятичное число
     * @returns {string|null} - Дробь в формате 'числитель/знаменатель' или null, если невозможно
     */
    function decimalToFraction(decimal) {
      const tolerance = 1.0E-6;
      let h1 = 1, h2 = 0;
      let k1 = 0, k2 = 1;
      let b = Math.abs(decimal);
      let sign = decimal < 0 ? '-' : '';

      while (Math.abs(h1 / k1 - b) > tolerance && k1 < 1000) {
        const a = Math.floor(b);
        const aux = h1;
        h1 = a * h1 + h2;
        h2 = aux;
        const auxk = k1;
        k1 = a * k1 + k2;
        k2 = auxk;
        b = 1 / (b - a);
        if (isNaN(b) || !isFinite(b)) break;
      }

      // Если знаменатель превышает 1000, не преобразуем
      if (k1 > 1000) return null;

      return sign + `${h1}/${k1}`;
    }
  </script>
</body>
</html>
